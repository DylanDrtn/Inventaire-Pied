<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventaire Pied de Table</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#fcfcfc;}
    .wrap{max-width:820px;margin:0 auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:16px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.04);}
    h1{margin:0 0 16px 0}
    label{font-weight:600}
    input,select,button{padding:10px;border:1px solid #ddd;border-radius:12px}
    button{cursor:pointer;background:#fff}
    button:hover{background:#f7f7f7}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa}
    td.low{color:#a50000;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .msg{min-height:1.2em;margin-top:8px;white-space:pre-line}
    .ok{color:#0a7f2e}.err{color:#a50000}.muted{color:#777}
    .banner{padding:10px;border-radius:10px;margin-bottom:12px}
    .banner.err{background:#ffecec;border:1px solid #ffb4b4;color:#900}
    .banner.ok{background:#ecfff0;border:1px solid #b4ffca;color:#074}
    code{background:#f3f3f3;padding:2px 4px;border-radius:6px}
  </style>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h1>Inventaire Pied de Table</h1>

  <div id="libStatus" class="banner" style="display:none;"></div>

  <div class="card">
    <div class="row">
      <div style="flex:1 1 260px">
        <label>Couleur</label><br>
        <!-- Liste FIXE (toujours visible) -->
        <select id="colorSelect">
          <option value="Cactus">Cactus</option>
          <option value="Capucine">Capucine</option>
          <option value="Bleu Abysse">Bleu Abysse</option>
          <option value="Anthracite">Anthracite</option>
          <option value="Blanc Coton">Blanc Coton</option>
          <option value="Réglisse">Réglisse</option>
          <option value="Romarin">Romarin</option>
          <option value="Tonka">Tonka</option>
          <option value="Vert Cèdre">Vert Cèdre</option>
          <option value="Vert Tilleul">Vert Tilleul</option>
          <option value="Muscade">Muscade</option>
          <option value="Carbone">Carbone</option>
          <option value="Citron givré">Citron givré</option>
          <option value="Gris argile">Gris argile</option>
          <option value="Ocre rouge">Ocre rouge</option>
          <option value="Orange confite">Orange confite</option>
          <option value="Miel">Miel</option>
          <option value="Pesto">Pesto</option>
        </select>
      </div>
      <div>
        <label>Quantité de pieds</label><br>
        <input id="qtyInput" type="number" min="0" placeholder="ex : 12" style="width:140px">
      </div>
      <div>
        <!-- on met l’handler en inline pour être sûr -->
        <button id="addBtn" onclick="addHandler()"><b>Ajouter</b></button>
      </div>
    </div>
    <div id="msg" class="msg"></div>
    <p class="muted" style="margin:6px 0 0">“Ajouter” met le stock Supabase <b>exactement</b> à la quantité saisie.</p>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Stock par couleur</h3>
    <table>
      <thead><tr><th>Couleur</th><th>Stock</th></tr></thead>
      <tbody id="stockBody"></tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL = "https://ytoxpennisgfzdtpxmgh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b3hwZW5uaXNnZnpkdHB4bWdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjc4OTIsImV4cCI6MjA3MzYwMzg5Mn0._FAylBUlh_Xr53z-KOJTy4HwBJgw1tMCxuCj146z3bM";

function setBanner(ok, text){
  const b = document.getElementById('libStatus');
  b.style.display = 'block';
  b.className = 'banner ' + (ok ? 'ok' : 'err');
  b.textContent = text;
}
function setMsg(cls, text){
  const m = document.getElementById('msg');
  m.className = 'msg ' + cls;
  m.textContent = text;
}

let supabase = null;

window.addEventListener('load', async () => {
  if(!window.supabase){
    setBanner(false, "❌ La librairie Supabase n'a pas été chargée. Vérifie que l'accès à https://unpkg.com est autorisé (réseau/AdBlock).");
    return;
  }
  setBanner(true, "✅ Librairie Supabase chargée.");
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  await loadStock();
});

async function loadStock(){
  if(!supabase){ return; }
  const { data, error } = await supabase.from('v_stock').select('*').order('color');
  if(error){
    setMsg('err', "❌ Lecture stock: " + error.message);
    return;
  }
  const tbody = document.getElementById('stockBody');
  tbody.innerHTML = (data||[]).map(r => {
    const qty = r.qty_current ?? 0;
    const cls = qty < 2 ? "low" : "";
    return `<tr><td>${r.color}</td><td class="${cls}">${qty}</td></tr>`;
  }).join('');
  setMsg('ok', "✅ Stock chargé.");
}

// Handler déclenché par le bouton
async function addHandler(){
  setMsg('muted', "⏳ Début…");
  if(!supabase){
    setMsg('err', "❌ Supabase non initialisé (librairie non chargée ?)");
    return;
  }
  const colorName = document.getElementById('colorSelect').value;
  const target = Number(document.getElementById('qtyInput').value);
  if(!colorName){ setMsg('err', "❌ Choisis une couleur."); return; }
  if(!Number.isFinite(target) || target < 0){ setMsg('err', "❌ Entre une quantité valide (≥ 0)."); return; }

  setMsg('muted', "⏳ Recherche de l'id pour « " + colorName + " »…");
  const { data: cdata, error: cerr } = await supabase.from('colors').select('id').eq('name', colorName).maybeSingle();
  if(cerr){ setMsg('err', "❌ Lecture couleur: " + cerr.message); return; }
  if(!cdata){ setMsg('err', `❌ Couleur absente en base. Ajoute-la:\ninsert into public.colors(name) values ('${colorName}') on conflict do nothing;`); return; }
  const colorId = cdata.id;

  setMsg('muted', "⏳ Lecture du stock actuel…");
  const { data: vs, error: verr } = await supabase.from('v_stock').select('qty_current').eq('color', colorName).maybeSingle();
  if(verr){ setMsg('err', "❌ Lecture stock actuel: " + verr.message); return; }
  const current = vs?.qty_current ?? 0;
  const delta = target - current;
  if(delta === 0){ setMsg('ok', `✅ « ${colorName} » est déjà à ${target}.`); return; }

  setMsg('muted', `⏳ Application du mouvement (Δ ${delta>0?'+':''}${delta})…`);
  const { error: rerr } = await supabase.rpc('apply_move', { p_color_id: colorId, p_delta: delta, p_note: `MAJ directe à ${target}` });
  if(rerr){ setMsg('err', "❌ Écriture stock: " + rerr.message); return; }

  setMsg('ok', `✅ « ${colorName} » : ${current} → ${target}`);
  document.getElementById('qtyInput').value = "";
  await loadStock();
}
</script>
</body>
</html>
