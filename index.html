<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventaire Pied de Table</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#fcfcfc;}
    .wrap{max-width:820px;margin:0 auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:16px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.04);}
    h1{margin:0 0 16px 0}
    label{font-weight:600}
    input,select,button{padding:10px;border:1px solid #ddd;border-radius:12px}
    button{cursor:pointer;background:#fff}
    button:hover{background:#f7f7f7}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa}
    td.low{color:#a50000;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .msg{min-height:1.4em;margin-top:8px;white-space:pre-line}
    .ok{color:#0a7f2e}.err{color:#a50000}.muted{color:#555}
    .banner{padding:10px;border-radius:10px;margin-bottom:12px}
    .banner.err{background:#ffecec;border:1px solid #ffb4b4;color:#900}
    .banner.ok{background:#ecfff0;border:1px solid #b4ffca;color:#074}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Inventaire Pied de Table</h1>

  <div id="libStatus" class="banner" style="display:none;"></div>

  <div class="card">
    <div class="row">
      <div style="flex:1 1 260px">
        <label>Couleur</label><br>
        <!-- Liste FIXE + on fusionnera avec celles de Supabase -->
        <select id="colorSelect">
          <option value="Cactus">Cactus</option>
          <option value="Capucine">Capucine</option>
          <option value="Bleu Abysse">Bleu Abysse</option>
          <option value="Anthracite">Anthracite</option>
          <option value="Blanc Coton">Blanc Coton</option>
          <option value="Réglisse">Réglisse</option>
          <option value="Romarin">Romarin</option>
          <option value="Tonka">Tonka</option>
          <option value="Vert Cèdre">Vert Cèdre</option>
          <option value="Vert Tilleul">Vert Tilleul</option>
          <option value="Muscade">Muscade</option>
          <option value="Carbone">Carbone</option>
          <option value="Citron givré">Citron givré</option>
          <option value="Gris argile">Gris argile</option>
          <option value="Ocre rouge">Ocre rouge</option>
          <option value="Orange confite">Orange confite</option>
          <option value="Miel">Miel</option>
          <option value="Pesto">Pesto</option>
        </select>
      </div>
      <div>
        <label>Quantité de pieds</label><br>
        <input id="qtyInput" type="number" min="0" placeholder="ex : 12" style="width:140px">
      </div>
      <div>
        <button id="addBtn"><b>Ajouter</b></button>
      </div>
    </div>
    <div id="msg" class="msg"></div>
    <p class="muted" style="margin:6px 0 0">“Ajouter” met le stock Supabase <b>exactement</b> à la quantité saisie.</p>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Stock par couleur</h3>
    <table>
      <thead><tr><th>Couleur</th><th>Stock</th></tr></thead>
      <tbody id="stockBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://ytoxpennisgfzdtpxmgh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b3hwZW5uaXNnZnpkdHB4bWdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjc4OTIsImV4cCI6MjA3MzYwMzg5Mn0._FAylBUlh_Xr53z-KOJTy4HwBJgw1tMCxuCj146z3bM";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- helpers ---------- */
const norm = s => (s||"").normalize('NFKC').toLowerCase().replace(/\s+/g,' ').trim();
const title = s => (s||"")
  .toLowerCase()
  .replace(/\S+/g, w => w.charAt(0).toUpperCase()+w.slice(1));

function setMsg(cls, text){
  const m = document.getElementById('msg');
  if(!m) return;
  m.className = 'msg ' + cls;
  m.textContent = text;
}

/* ---------- construit une liste UNIQUE pour le menu ---------- */
async function buildUniqueDropdown(){
  const sel = document.getElementById('colorSelect');

  // 1) récupère les noms venant du HTML actuel
  const fixed = Array.from(sel.options).map(o => o.value);

  // 2) récupère les noms venant de Supabase
  const { data: rows, error } = await supabase.from('colors').select('name');
  const fromDb = error ? [] : (rows||[]).map(r => r.name);

  // 3) fusion + dédoublonnage (insensible à la casse/espaces)
  const byKey = new Map(); // key normalisée -> libellé d'affichage
  for(const n of [...fixed, ...fromDb]){
    const k = norm(n);
    if(!k) continue;
    if(!byKey.has(k)) byKey.set(k, title(n));
  }

  // 4) remplit le <select> proprement (trié)
  sel.innerHTML = '';
  [...byKey.values()].sort((a,b)=>a.localeCompare(b))
    .forEach(name => {
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      sel.appendChild(opt);
    });
}

/* ---------- charge le stock en DÉDOUBLONNANT ---------- */
async function loadStock(){
  const { data, error } = await supabase.from('v_stock').select('*');
  if(error){ setMsg('err', "Lecture stock: " + error.message); return; }

  // groupe par nom normalisé et cumule les quantités
  const grouped = new Map(); // key -> {name, qty}
  for(const r of (data||[])){
    const key = norm(r.color);
    const name = title(r.color);
    const qty = r.qty_current ?? 0;
    if(!grouped.has(key)) grouped.set(key, { name, qty: 0 });
    grouped.get(key).qty += qty;
  }

  const rows = [...grouped.values()]
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(({name, qty})=>{
      const cls = qty < 2 ? "low" : "";
      return `<tr><td>${name}</td><td class="${cls}">${qty}</td></tr>`;
    }).join('');

  document.getElementById('stockBody').innerHTML = rows || '<tr><td colspan="2">Aucune donnée</td></tr>';
  setMsg('ok', "Stock chargé.");
}

/* ---------- “Ajouter” : met exactement la quantité demandée ---------- */
async function setExactQuantity(){
  setMsg('muted', "⏳ Début…");
  const colorName = document.getElementById('colorSelect').value;
  const target = Number(document.getElementById('qtyInput').value);

  if(!colorName){ setMsg('err', "❌ Choisis une couleur."); return; }
  if(!Number.isFinite(target) || target < 0){ setMsg('err', "❌ Entre une quantité valide (≥ 0)."); return; }

  // retrouve l'id dans la base en tolérant la casse
  const { data: cdata, error: cerr } = await supabase.from('colors')
    .select('id,name').ilike('name', colorName).maybeSingle();
  if(cerr){ setMsg('err', "❌ Lecture couleur: " + cerr.message); return; }
  if(!cdata){ setMsg('err', `❌ Couleur absente en base: ${colorName}`); return; }
  const colorId = cdata.id;

  // lit le stock actuel (fusionné)
  const { data: vs } = await supabase.from('v_stock').select('color, qty_current');
  const current = (vs||[]).filter(r => norm(r.color) === norm(colorName))
                          .reduce((sum,r)=>sum+(r.qty_current||0), 0);

  const delta = target - current;
  if(delta === 0){ setMsg('ok', `✅ « ${title(colorName)} » est déjà à ${target}.`); return; }

  const { error: rerr } = await supabase.rpc('apply_move', { p_color_id: colorId, p_delta: delta, p_note: `MAJ directe à ${target}` });
  if(rerr){ setMsg('err', "❌ Écriture stock: " + rerr.message); return; }

  setMsg('ok', `✅ « ${title(colorName)} » : ${current} → ${target}`);
  document.getElementById('qtyInput').value = "";
  await loadStock();
}

/* ---------- events & init ---------- */
document.getElementById('addBtn').addEventListener('click', setExactQuantity);

(async function init(){
  await buildUniqueDropdown();
  await loadStock();
  try {
    supabase.channel('stock_changes')
      .on('postgres_changes', {event:'*', schema:'public', table:'legs_stock'}, loadStock)
      .subscribe();
  } catch(_) {}
})();
</script>
</body>
</html>
