<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Inventaire Pied de Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --brand:#5a7d3a; --brand-600:#4f7133;
      --bg:#f9f9f9; --line:#e5e7eb; --danger:#b00020;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:#222}
    header{
      display:flex; align-items:center; gap:12px;
      padding:12px 16px; border-bottom:1px solid var(--line);
      background:linear-gradient(0deg,var(--brand-600),var(--brand)); color:#fff;
    }
    .h-left,.h-right{width:160px; display:flex; align-items:center; justify-content:center}
    .h-center{flex:1; text-align:center}
    header h1{margin:0; font-size:22px; letter-spacing:.2px}
    .logo{height:48px; object-fit:contain; max-width:150px}
    .wrap{max-width:980px; margin:0 auto; padding:16px}

    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-size:14px; border:1px solid var(--line);
      background:rgba(255,255,255,.92); color:#333;
      box-shadow: 0 1px 4px rgba(0,0,0,.05);
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .ok{background:#16a34a}.warn{background:#f59e0b}.bad{background:#ef4444}

    .card{
      background:#fff;border:1px solid var(--line);border-radius:14px; padding:16px; margin-top:16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    label{font-weight:600}
    input,select{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    button{
      padding:10px 14px;border:1px solid var(--brand-600);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;
      transition: transform .06s ease, background .2s ease, box-shadow .2s ease;
    }
    button:hover{background:var(--brand-600); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(76,114,51,.18);}
    button:active{transform: translateY(0); box-shadow:none;}

    /* Tableau amélioré */
    table{
      width:100%;border-collapse:separate;border-spacing:0;background:#fff;
      border:1px solid var(--line); border-radius:12px; overflow:hidden;
      position: relative;
    }
    thead th{
      position: sticky; top: 0; z-index: 1;
      background:#f3f6ef; letter-spacing:.2px; border-bottom:1px solid var(--line);
    }
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    td{line-height:1.3;}
    td.low{color:var(--danger);font-weight:700}
    tbody tr:nth-child(even){ background:#fafafa; }
    tbody tr:hover{ background:#f1f6ed; }
    .swatch{
      display:inline-block;width:16px;height:16px;border-radius:50%;margin-right:6px;
      border:1px solid rgba(0,0,0,.2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.5);
      vertical-align:-2px;
    }
    tbody td:nth-child(2){
      font-weight:600;
      background:#eef5e9;
      color:#355a22;
      border-radius:999px;
      padding:6px 10px;
      display:inline-block;
      margin:2px 0;
    }

    /* Barre outils du tableau */
    .tools{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      margin:6px 0 10px;
    }
    .tools .left, .tools .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{
      background:#e5e9e5; color:#222; font-weight:600;
      border:1px solid var(--brand-600); border-radius:999px; padding:6px 12px; cursor:pointer;
    }
    .chip.active{ background:var(--brand); color:#fff; }

    /* Totaux */
    .totals{
      margin-top:10px; font-weight:600; color:#355a22;
      display:flex; gap:12px; flex-wrap:wrap;
    }
    .totals .pill{
      background:#eef5e9; border:1px solid #dbe8d8; border-radius:999px; padding:6px 10px;
    }

    /* Mobile */
    @media (max-width:640px){
      header h1{ font-size:18px; }
      .wrap{ padding:12px; }
      th, td{ padding:8px; font-size:14px; }
      .card{ padding:12px; }
      .tools{ flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <header>
    <div class="h-left">
      <img id="fermobLogo" class="logo" alt="Fermob" src="./fermob.png">
      <span id="fermobTxt" style="display:none;font-weight:700">Fermob</span>
    </div>
    <div class="h-center">
      <h1>Inventaire Pied de Table</h1>
      <div id="status" class="status" title="État de la connexion">
        <span id="statusDot" class="dot warn"></span><span id="statusText">⏳ Vérification…</span>
      </div>
    </div>
    <div class="h-right">
      <img id="rodetLogo" class="logo" alt="Rodet" src="./rodet.png">
      <span id="rodetTxt" style="display:none;font-weight:700">Rodet</span>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row" style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
        <div style="flex:1 1 260px">
          <label>Couleur</label><br />
          <select id="colorSelect"></select>
        </div>

        <div style="flex:1 1 220px">
          <label>Type de pied</label><br />
          <select id="typeSelect">
            <option value="Petite table">Petite table</option>
            <option value="Grande table">Grande table</option>
          </select>
          <div id="refBox" class="ref" style="font-size:12px;color:#666;margin-top:6px"></div>
        </div>

        <div>
          <label>Quantité de pieds</label><br />
          <input id="qtyInput" type="number" min="0" placeholder="ex : 12" style="width:140px" />
        </div>

        <div>
          <button id="addBtn"><b>Ajouter</b></button>
        </div>
      </div>
      <div id="msg" class="msg" style="min-height:1.4em;margin-top:8px"></div>
      <p class="msg muted" style="margin:6px 0 0;color:#666">“Ajouter” met le stock <b>exact</b> (le site calcule la différence automatiquement).</p>
    </div>

    <div class="card">
      <div class="tools">
        <div class="left">
          <h3 style="margin:0">Stock par couleur et type</h3>
        </div>
        <div class="right">
          <input id="filterInput" type="text" placeholder="Rechercher une couleur…" style="padding:8px 10px;border:1px solid var(--line);border-radius:10px;width:200px">
          <button id="sortName" class="chip" title="Trier par nom">Nom A→Z</button>
          <button id="sortQty" class="chip" title="Trier par stock">Stock ⬇︎</button>
        </div>
      </div>

      <table>
        <thead><tr><th>Couleur</th><th>Type</th><th>Stock</th></tr></thead>
        <tbody id="stockBody"></tbody>
      </table>

      <div id="totals" class="totals" aria-live="polite"></div>
    </div>
  </div>

  <!-- Lib Supabase en global -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Script principal en module -->
  <script type="module">
    // ====== Import robuste de colors.js (avec fallback) ======
    let COLOR_HEX = {};
    try {
      // cache-busting pour éviter un ancien fichier
      const mod = await import('./colors.js?v=' + Date.now());
      COLOR_HEX = mod?.COLOR_HEX || {};
    } catch (e) {
      console.warn('colors.js introuvable, on continue sans (fallback internes).', e);
      COLOR_HEX = {};
    }

    // Anti-cache logos
    const versionParam='?v='+new Date().getTime();
    document.getElementById('fermobLogo').src='./fermob.png'+versionParam;
    document.getElementById('rodetLogo').src='./rodet.png'+versionParam;

    // Supabase
    const SUPABASE_URL="https://ytoxpennisgfzdtpxmgh.supabase.co";
    const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b3hwZW5uaXNnZnpkdHB4bWdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjc4OTIsImV4cCI6MjA3MzYwMzg5Mn0._FAylBUlh_Xr53z-KOJTy4HwBJgw1tMCxuCj146z3bM";
    const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

    // Helpers
    const TYPE_REFS={"Petite table":"143x80 / 80x80","Grande table":"165x10 / 207x10"};
    const $=sel=>document.querySelector(sel);
    const norm=s=>(s||"").normalize('NFKC').toLowerCase().replace(/\s+/g,' ').trim();
    const titleCase=s=>(s||"").toLowerCase().replace(/\S+/g,w=>w.charAt(0).toUpperCase()+w.slice(1));
    function setMsg(kind,txt){const m=$("#msg");m.className="msg "+kind;m.textContent=txt;}
    function setStatus(kind,text){const d=$("#statusDot"),t=$("#statusText");d.className="dot "+(kind==="ok"?"ok":kind==="bad"?"bad":"warn");t.textContent=text;}
    function refreshRef(){const t=$("#typeSelect").value;$("#refBox").textContent="Réf : "+(TYPE_REFS[t]||"-");}

    function hashColor(str){
      const s=(str||"").toLowerCase().trim();let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}
      const hue=Math.abs(h)%360;return `hsl(${hue} 55% 45%)`;
    }

    const HEX_BY_NAME=new Map();
    async function loadColors(){
      const {data,error}=await sb.from('colors').select('id,name,hex').eq('active',true).order('name');
      if(error){setMsg('err',"Lecture couleurs: "+error.message);return;}
      HEX_BY_NAME.clear();
      const sel=$("#colorSelect");sel.innerHTML='';
      const seen=new Set();
      for(const r of (data||[])){
        const k=norm(r.name);
        if(!seen.has(k)){seen.add(k);
          if(r.hex) HEX_BY_NAME.set(k,r.hex);
          const opt=document.createElement('option');opt.value=String(r.id);opt.textContent=titleCase(r.name);sel.appendChild(opt);
        }
      }
    }

    function hexForDisplay(name){
      const k=norm(name);
      const fromDb=HEX_BY_NAME.get(k);
      if(fromDb && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(fromDb)) return fromDb;
      const fromLocal=COLOR_HEX[k]; if(fromLocal) return fromLocal;
      return hashColor(k);
    }

    let FULL_ROWS=[]; let VIEW_ROWS=[];
    let SORT_NAME_ASC=true; let SORT_QTY_DESC=true;

    function applyFilterSort(){
      const q=norm($("#filterInput").value);
      VIEW_ROWS = FULL_ROWS.filter(r => !q || norm(r.color).includes(q));
      if($("#sortQty").classList.contains('active')){
        VIEW_ROWS.sort((a,b)=> (b.qty_current??0) - (a.qty_current??0));
        if(!SORT_QTY_DESC) VIEW_ROWS.reverse();
      }else{
        VIEW_ROWS.sort((a,b)=> norm(a.color).localeCompare(norm(b.color)));
        if(!SORT_NAME_ASC) VIEW_ROWS.reverse();
      }
      renderTable(VIEW_ROWS);
      renderTotals(VIEW_ROWS);
    }

    function setActiveChip(btn){
      $("#sortName").classList.remove('active');
      $("#sortQty").classList.remove('active');
      btn.classList.add('active');
    }

    function renderTable(rows){
      const tb=$("#stockBody"); tb.innerHTML='';
      rows.forEach(r=>{
        const hex=hexForDisplay(r.color);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><span class="swatch" style="background:${hex}"></span>${titleCase(r.color)}</td>
                      <td>${r.type||'Grande table'}</td>
                      <td ${r.qty_current<2?'class="low"':''}>${r.qty_current}</td>`;
        tb.appendChild(tr);
      });
      setMsg('ok',rows.length?"Stock chargé.":"Aucune ligne enregistrée.");
    }

    function renderTotals(rows){
      let petite=0, grande=0, total=0;
      for(const r of rows){
        const q=r.qty_current??0;
        total+=q;
        if((r.type||'Grande table')==='Petite table') petite+=q; else grande+=q;
      }
      $("#totals").innerHTML=`
        <div class="pill">Petite table : ${petite}</div>
        <div class="pill">Grande table : ${grande}</div>
        <div class="pill">Total : ${total}</div>
      `;
    }

    async function loadStock(){
      const {data,error}=await sb.from('v_stock').select('*');
      if(error){setMsg('err',"Lecture stock: "+error.message);return;}
      const rows=(data||[]).filter(r=>(r.qty_current??0)>0);
      FULL_ROWS=rows.slice();
      applyFilterSort();
    }

    async function addExact(){
      setMsg('muted',"⏳ Traitement…");
      const colorId=Number($("#colorSelect").value);
      const colorName=$("#colorSelect").selectedOptions[0]?.textContent||'';
      const type=$("#typeSelect").value;
      const target=Number($("#qtyInput").value);
      if(!Number.isFinite(colorId)) return setMsg('err',"❌ Choisis une couleur.");
      if(!type) return setMsg('err',"❌ Choisis un type.");
      if(!Number.isFinite(target)||target<0) return setMsg('err',"❌ Quantité (≥ 0).");
      const {data:cur,error:cerr}=await sb.from('legs_stock').select('qty').eq('color_id',colorId).eq('type',type).maybeSingle();
      if(cerr){setMsg('err',"❌ Lecture stock actuel: "+cerr.message);return;}
      const current=cur?.qty??0; const delta=target-current;
      if(delta===0){setMsg('ok',`✅ « ${colorName} / ${type} » est déjà à ${target}.`);return;}
      const {error:rerr}=await sb.rpc('apply_move',{p_color_id:colorId,p_delta:delta,p_note:`MAJ ${current}→${target}`,p_type:type});
      if(rerr){setMsg('err',"❌ Écriture stock: "+rerr.message);return;}
      setMsg('ok',`✅ « ${colorName} / ${type} » : ${current} → ${target}`);
      $("#qtyInput").value=""; await loadStock();
    }

    async function checkConnection(){
      try{
        if(!navigator.onLine){setStatus('warn','⚠️ Hors ligne (navigateur)');return;}
        const {error}=await sb.from('colors').select('id').limit(1);
        if(error){setStatus('bad','❌ Supabase indisponible');}
        else{setStatus('ok','✅ Connecté');}
      }catch{
        setStatus('bad','❌ Erreur de connexion');
      }
    }

    async function init(){
      // écouteurs UI
      document.getElementById("addBtn").addEventListener('click',addExact);
      document.getElementById("typeSelect").addEventListener('change',refreshRef);
      document.getElementById("filterInput").addEventListener('input',applyFilterSort);
      document.getElementById("sortName").addEventListener('click',()=>{
        SORT_NAME_ASC=!SORT_NAME_ASC;
        setActiveChip(document.getElementById("sortName"));
        document.getElementById("sortName").textContent=SORT_NAME_ASC?"Nom A→Z":"Nom Z→A";
        applyFilterSort();
      });
      document.getElementById("sortQty").addEventListener('click',()=>{
        SORT_QTY_DESC=!SORT_QTY_DESC;
        setActiveChip(document.getElementById("sortQty"));
        document.getElementById("sortQty").textContent=SORT_QTY_DESC?"Stock ⬇︎":"Stock ⬆︎";
        applyFilterSort();
      });
      setActiveChip(document.getElementById("sortQty")); // tri par stock au départ
      refreshRef();

      // chargements
      await loadColors().catch(()=>{ /* on continue */ });
      await loadStock().catch(()=>{ /* on continue */ });
      await checkConnection();

      // live updates
      sb.channel('stock_changes')
        .on('postgres_changes',{event:'*',schema:'public',table:'legs_stock'},()=>loadStock())
        .subscribe();

      setInterval(loadStock,30000);
      window.addEventListener('online',()=>{setStatus('warn','⏳ Reconnexion…');loadStock().then(checkConnection);});
      window.addEventListener('offline',()=>setStatus('warn','⚠️ Hors ligne'));
    }
    init();
  </script>
</body>
</html>