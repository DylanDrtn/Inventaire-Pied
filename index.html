<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire Pied de Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:Arial, sans-serif;background:#f9f9f9;margin:0;text-align:center;color:#222}
    header{background:#37474F;color:#fff;padding:14px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:20px}
    header img{height:30px;margin-left:10px}
    main{padding:16px}
    form{margin:16px auto;background:#fff;max-width:420px;padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    table{width:92%;max-width:900px;margin:18px auto;background:#fff;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#eee}
    td.low{background:#ffe6e6}
    .color-label{display:flex;align-items:center;gap:8px;justify-content:center}
    .color-dot{width:14px;height:14px;border-radius:50%;display:inline-block;border:1px solid #444}
    footer{margin:16px 0;color:#666;font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>Inventaire Pied de Table</h1>
    <div>
      <img src="fermob.png" alt="Fermob">
      <img src="rodet.png" alt="Rodet">
    </div>
  </header>

  <main>
    <form id="stockForm">
      <div>
        <label>Couleur :
          <select id="colorSelect"></select>
        </label>
      </div>
      <div style="margin-top:10px">
        <label>Quantité :
          <input type="number" id="qtyInput" value="1" min="0">
        </label>
      </div>
      <button type="submit" style="margin-top:10px">Ajouter</button>
    </form>

    <table>
      <thead><tr><th>Couleur</th><th>Type</th><th>Quantité</th></tr></thead>
      <tbody id="stockBody"></tbody>
    </table>
  </main>

  <footer>Inventaire connecté • Actualisation auto toutes les 30s</footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://ytoxpennisgfzdtpxmgh.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b3hwZW5uaXNnZnpkdHB4bWdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjc4OTIsImV4cCI6MjA3MzYwMzg5Mn0._FAylBUlh_Xr53z-KOJTy4HwBJgw1tMCxuCj146z3bM";
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Correction couleurs spécifiques ---
    function norm(str){ return (str||"").toLowerCase().trim(); }
    const COLOR_HEX = {
      "pain d'épices": "#986F31",
      "pain d’epices": "#986F31",
      "orange confite": "#9C4B1C",
      "gris lapili": "#8C9491",
      "gris lapilli": "#8C9491"
    };
    function colorHexFromName(name){
      const k = norm(name);
      if (COLOR_HEX[k]) return COLOR_HEX[k];
      return "#444"; // couleur neutre par défaut
    }

    async function loadStock(){
      const { data, error } = await sb.from("v_stock").select("*").order("color");
      if(error){ console.error(error); return; }
      const tbody = document.getElementById("stockBody");
      tbody.innerHTML = "";
      data.forEach(r=>{
        const hex = colorHexFromName(r.color);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="color-label">
            <span class="color-dot" style="background:${hex}"></span>
            ${r.color}
          </td>
          <td>${r.type || ""}</td>
          <td ${r.qty_current<2?'class="low"':''}>${r.qty_current}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function buildColors(){
      const { data, error } = await sb.from("colors").select("id,name").order("name");
      if(error){ console.error(error); return; }
      const select = document.getElementById("colorSelect");
      select.innerHTML = "";
      data.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
    }

    document.getElementById("stockForm").addEventListener("submit", async e=>{
      e.preventDefault();
      const colorId = document.getElementById("colorSelect").value;
      const qty = parseInt(document.getElementById("qtyInput").value)||0;
      const { error } = await sb.rpc("apply_move", { p_color_id: colorId, p_delta: qty, p_note: "ajout via site" });
      if(error){ alert("❌ Écriture stock: " + error.message); }
      else loadStock();
    });

    buildColors();
    loadStock();
    setInterval(loadStock, 30000);
  </script>
</body>
</html>