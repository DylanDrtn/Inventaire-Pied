<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventaire Pied de Table</title>
  <style>
    :root{ --brand:#5a7d3a; --brand-600:#4f7133; --brand-50:#f0f6ec;
           --text:#1f2937; --muted:#6b7280; --danger:#a50000; --card:#ffffff; --line:#e5e7eb; }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(rgba(90,125,58,.08) 1px, transparent 1px) 0 0/18px 18px,
        radial-gradient(rgba(90,125,58,.05) 1px, transparent 1px) 9px 9px/18px 18px,
        #f7faf5;
    }
    .topbar{background:linear-gradient(0deg,var(--brand-600),var(--brand));color:#fff;padding:14px 0;position:sticky;top:0;z-index:10;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    .header{display:flex;align-items:center;gap:14px}
    .logo{height:42px;width:auto;object-fit:contain;display:block}
    .logo--invert{filter:brightness(0) invert(1)}
    .logo-text{display:none;font-weight:800;letter-spacing:.3px;font-size:22px}
    h1{margin:0;font-weight:700;letter-spacing:.2px;font-size:20px}
    .content{padding:20px 16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;background:var(--card);box-shadow:0 2px 10px rgba(0,0,0,.05)}
    label{font-weight:600}
    input,select{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
    button{padding:10px 14px;border:1px solid var(--brand-600);border-radius:12px;background:var(--brand);color:#fff;cursor:pointer;transition:transform .02s ease, background .15s}
    button:hover{background:var(--brand-600)} button:active{transform:scale(.98)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:var(--brand-50)}
    td.low{color:var(--danger);font-weight:700}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    .msg{min-height:1.4em;margin-top:8px;white-space:pre-line}
    .ok{color:#0a7f2e}.err{color:var(--danger)}.muted{color:var(--muted)}
    .ref{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="topbar">
    <div class="wrap">
      <div class="header">
        <img id="logoImg" class="logo logo--invert" alt="Fermob" src="" />
        <span id="logoText" class="logo-text">Fermob</span>
        <h1>Inventaire Pied de Table</h1>
      </div>
    </div>
  </div>

  <!-- CONTENU -->
  <div class="content">
    <div class="wrap">

      <div class="card">
        <div class="row">
          <div style="flex:1 1 260px">
            <label>Couleur</label><br>
            <!-- ATTENTION: value = ID de la couleur -->
            <select id="colorSelect"></select>
          </div>

          <div style="flex:1 1 220px">
            <label>Type de pied</label><br>
            <select id="typeSelect">
              <option value="Petite table">Petite table</option>
              <option value="Grande table">Grande table</option>
            </select>
            <div id="refBox" class="ref"></div>
          </div>

          <div>
            <label>Quantité de pieds</label><br>
            <input id="qtyInput" type="number" min="0" placeholder="ex : 12" style="width:140px">
          </div>

          <div>
            <button id="addBtn"><b>Ajouter</b></button>
          </div>
        </div>
        <div id="msg" class="msg"></div>
        <p class="muted" style="margin:6px 0 0">“Ajouter” met le stock Supabase <b>exactement</b> à la quantité saisie.</p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px">Stock par couleur et type</h3>
        <table>
          <thead><tr><th>Couleur</th><th>Type</th><th>Référence</th><th>Stock</th></tr></thead>
          <tbody id="stockBody"></tbody>
        </table>
      </div>

    </div>
  </div>

<script type="module">
/* ====== Config & lib ====== */
const TYPE_REFS = { "Petite table":"14x8 / 8x8", "Grande table":"165x10 / 207x10" };

(async function loadLogo(){
  const logoEl = document.getElementById('logoImg');
  const textEl = document.getElementById('logoText');
  try{
    const r = await fetch('logo.png', {method:'HEAD', cache:'no-store'});
    if(r.ok){ logoEl.src='logo.png'; logoEl.classList.remove('logo--invert'); return; }
  }catch(_){}
  logoEl.onerror = ()=>{ logoEl.style.display='none'; textEl.style.display='inline-block'; };
  logoEl.src = 'https://upload.wikimedia.org/wikipedia/commons/7/7f/Fermob_logo.png';
})();

const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
const supabase = createClient(
  "https://ytoxpennisgfzdtpxmgh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b3hwZW5uaXNnZnpkdHB4bWdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjc4OTIsImV4cCI6MjA3MzYwMzg5Mn0._FAylBUlh_Xr53z-KOJTy4HwBJgw1tMCxuCj146z3bM"
);

/* ====== Helpers ====== */
const norm = s => (s||"").normalize('NFKC').toLowerCase().replace(/\s+/g,' ').trim();
const title = s => (s||"").toLowerCase().replace(/\S+/g, w => w.charAt(0).toUpperCase()+w.slice(1));
function setMsg(cls, text){ const m=document.getElementById('msg'); m.className='msg '+cls; m.textContent=text; }
function refreshRefBox(){ const t=document.getElementById('typeSelect').value; document.getElementById('refBox').textContent="Réf : "+(TYPE_REFS[t]||"-"); }

/* ====== Couleurs : menu = ID (corrige le bug des doublons) ====== */
async function buildUniqueDropdown(){
  const sel = document.getElementById('colorSelect');
  const { data: rows, error } = await supabase.from('colors').select('id,name').order('name');
  if(error){ setMsg('err', "Lecture couleurs: " + error.message); return; }

  // dédoublonne par nom normalisé → garde la première id rencontrée
  const byKey = new Map(); // key -> {id,name}
  for(const r of (rows||[])){
    const k = norm(r.name);
    if(k && !byKey.has(k)) byKey.set(k, { id: r.id, name: title(r.name) });
  }

  sel.innerHTML = '';
  [...byKey.values()]
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(({id,name})=>{
      const opt = document.createElement('option');
      opt.value = String(id);   // <<<<<< ID en value
      opt.textContent = name;   // texte affiché = nom propre
      sel.appendChild(opt);
    });
}

/* ====== Tableau : n’affiche que les lignes > 0 (depuis la vue v_stock) ====== */
async function loadStock(){
  const { data, error } = await supabase.from('v_stock').select('*');
  if(error){ setMsg('err', "Lecture stock: " + error.message); return; }

  const only = (data||[]).filter(r => (r.qty_current ?? 0) > 0);
  const grouped = new Map(); // key = norm(color)+'|'+type
  for(const r of only){
    const key = norm(r.color)+'|'+(r.type||'Grande table');
    const name = title(r.color);
    const type = r.type || 'Grande table';
    const qty  = r.qty_current ?? 0;
    if(!grouped.has(key)) grouped.set(key,{name,type,qty:0});
    grouped.get(key).qty += qty;
  }
  const rows = [...grouped.values()]
    .sort((a,b)=>a.name.localeCompare(b.name) || a.type.localeCompare(b.type))
    .map(({name,type,qty})=>{
      const ref = TYPE_REFS[type] || "-";
      return `<tr><td>${name}</td><td>${type}</td><td>${ref}</td><td>${qty}</td></tr>`;
    }).join('');
  document.getElementById('stockBody').innerHTML = rows || '<tr><td colspan="4">Aucune donnée</td></tr>';
  setMsg(rows ? 'ok' : 'muted', rows ? "Stock chargé." : "Aucune ligne enregistrée.");
}

/* ====== Ajouter : calcule Δ en lisant le stock par color_id + type ====== */
async function setExactQuantity(){
  setMsg('muted', "⏳ Début…");
  const colorId  = Number(document.getElementById('colorSelect').value); // ID direct
  const nameText = document.getElementById('colorSelect').selectedOptions[0]?.textContent || '';
  const typeName = document.getElementById('typeSelect').value;
  const target   = Number(document.getElementById('qtyInput').value);

  if(!Number.isFinite(colorId)){ setMsg('err',"❌ Choisis une couleur."); return; }
  if(!typeName){ setMsg('err', "❌ Choisis un type."); return; }
  if(!Number.isFinite(target) || target < 0){ setMsg('err', "❌ Quantité (≥ 0)."); return; }

  // Lire le stock actuel directement dans legs_stock par (color_id, type)
  const { data: cur, error: cerr } = await supabase
    .from('legs_stock')
    .select('qty')
    .eq('color_id', colorId)
    .eq('type', typeName)
    .maybeSingle();
  if(cerr){ setMsg('err', "❌ Lecture stock actuel: " + cerr.message); return; }
  const current = cur?.qty ?? 0;

  const delta = target - current;
  if(delta === 0){ setMsg('ok', `✅ « ${nameText} / ${typeName} » est déjà à ${target}.`); return; }

  // Appliquer le mouvement avec p_type
  const { error: rerr } = await supabase.rpc('apply_move', {
    p_color_id: colorId, p_delta: delta, p_note: `MAJ directe à ${target}`, p_type: typeName
  });
  if(rerr){ setMsg('err', "❌ Écriture stock: " + rerr.message); return; }

  setMsg('ok', `✅ « ${nameText} / ${typeName} » : ${current} → ${target}`);
  document.getElementById('qtyInput').value = "";
  await loadStock();
}

/* ====== Events + init ====== */
document.getElementById('addBtn').addEventListener('click', setExactQuantity);
document.getElementById('typeSelect').addEventListener('change', () => {
  const t = document.getElementById('typeSelect').value;
  document.getElementById('refBox').textContent = "Réf : " + (TYPE_REFS[t] || "-");
});

(async function init(){
  const logoEl = document.getElementById('logoImg');
  const textEl = document.getElementById('logoText');
  // fallback logo local > wiki > texte
  try{
    const r = await fetch('logo.png', {method:'HEAD', cache:'no-store'});
    if(r.ok){ logoEl.src='logo.png'; logoEl.classList.remove('logo--invert'); }
    else { logoEl.onerror = ()=>{ logoEl.style.display='none'; textEl.style.display='inline-block'; }; logoEl.src='https://upload.wikimedia.org/wikipedia/commons/7/7f/Fermob_logo.png'; }
  }catch(_){ logoEl.style.display='none'; textEl.style.display='inline-block'; }

  document.getElementById('refBox').textContent = "Réf : " + (TYPE_REFS["Petite table"]);
  await buildUniqueDropdown();
  await loadStock();

  try {
    supabase.channel('stock_changes')
      .on('postgres_changes', {event:'*', schema:'public', table:'legs_stock'}, loadStock)
      .subscribe();
  } catch(_) {}
})();
</script>
</body>
</html>